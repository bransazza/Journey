<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeri</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Lobster+Two:ital,wght@0,400;0,700;1,400&family=Patrick+Hand&family=Quicksand:wght@400;600;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div id="background-decor"></div>

    <div id="login-page" class="login-overlay">
        <div class="login-paper">
            <div class="tape-login"></div>
            <div class="stamp-secret">TOP SECRET</div>
            <h1>Journal</h1>
            <p>Masukkan kata sandi:</p>
            <div class="login-input-group">
                <input type="password" id="passcode" placeholder="Ketik di sini...">
            </div>
            <button onclick="checkLogin()">Login</button>
            <p id="error-msg"></p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <nav class="navbar">
            <div class="nav-brand">Scrapbook</div>
            <div class="nav-menu">
                <button onclick="switchTab('gallery')" class="nav-btn active-btn" id="btn-view">Galeri</button>
                <button onclick="switchTab('plans')" class="nav-btn" id="btn-plans">Plan</button>
                <button onclick="switchTab('add')" class="nav-btn" id="btn-add">Upload Galeri</button>
                <button onclick="logout()" class="nav-btn logout">Tutup</button>
            </div>
        </nav>

        <div class="container">
            <div class="timer-paper">
                <div class="pin"></div>
                <div id="timer">Menghitung hari...</div>
            </div>

            <section id="add-section" class="hidden">
                <div class="form-paper">
                    <div class="tape-corner"></div>
                    <h2>üìù Tulis Kenangan</h2>
                    <form id="memoryForm">
                        <div class="form-group">
                            <label>1. Pilih Foto:</label>
                            <input type="file" id="photo" accept="image/*" required>
                        </div>
                        <div class="form-group">
                            <label>2. Beri Judul:</label>
                            <input type="text" id="title" placeholder="Momen apa ini?" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tanggal:</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="form-group">
                                <label>Label:</label>
                                <select id="tag">
                                    <option value="Date">Date ‚ù§Ô∏è</option>
                                    <option value="Trip">Jalan-jalan ‚úàÔ∏è</option>
                                    <option value="Eat">Kulineran üçú</option>
                                    <option value="Random">Random ü§™</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>3. Ceritakan:</label>
                            <textarea id="desc" rows="4" placeholder="Tulis cerita di sini..." required></textarea>
                        </div>
                        <button type="submit" id="btnSubmitFirebase" class="btn-scrap">Simpan ke Awan ‚òÅÔ∏è</button>
                    </form>
                </div>
            </section>

            <section id="plans-section" class="hidden">
                <div class="plans-container">
                    <div class="paper-list travel-card">
                        <div class="stamp-decor">‚úàÔ∏èLet's Go</div>
                        <div class="tape-top-left"></div>
                        <h3>üåç Place to go</h3>
                        <div class="input-row-plan">
                            <input type="text" id="placeInput" placeholder="Mau kemana nih kita?">
                            <button onclick="addPlace()">GO!</button>
                        </div>
                        <ul id="placesList" class="scrap-list"></ul>
                    </div>

                    <div class="paper-list bucket-card">
                        <div class="tape-bucket-center"></div>
                        <div class="doodle-star">‚òÖ</div>
                        <h3>üìù Things to do</h3>
                        <div class="input-row-plan">
                            <input type="text" id="todoInput" placeholder="Mau ngapain nih kita?">
                            <button onclick="addTodo()">ADD</button>
                        </div>
                        <ul id="todoList" class="scrap-list checklist"></ul>
                    </div>
                </div>
            </section>

            <section id="gallery-section">
                <div id="highlight-wrapper" class="hidden">
                    <div class="vintage-slider">
                        <div class="slider-tape"></div>
                        <div id="slider-track" class="slider-track"></div>
                    </div>
                </div>

                <div class="controls-area">
                    <input type="text" id="searchInput" placeholder="Cari kenangan..." onkeyup="filterLocalGallery()">

                    <select id="sortOrder" onchange="loadGalleryFromFirebase()">
                        <option value="desc">Paling Baru</option>
                        <option value="asc">Paling Lama</option>
                    </select>
                </div>

                <div id="gallery" class="scrapbook-wall"></div>
            </section>

        </div>
    </div>

    <div class="vinyl-player" id="music-widget">
        <button class="toggle-player-btn" onclick="toggleWidget()">‚úñ</button>
        <div class="vinyl-disk" id="vinyl">
            <div class="vinyl-grooves"></div>
            <div class="vinyl-label">üéµ</div>
        </div>
        <div class="player-info">
            <div class="now-playing-label">NOW PLAYING</div>
            <div class="song-title-wrapper">
                <span id="song-title">Select a song...</span>
            </div>
            <div class="player-controls">
                <button onclick="prevSong()">‚èÆ</button>
                <button onclick="toggleMusic()" id="play-btn">‚ñ∂</button>
                <button onclick="nextSong()">‚è≠</button>
            </div>
        </div>
        <audio id="audio"></audio>
    </div>

    <script src="script.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- KONFIGURASI ---
        const firebaseConfig = {
            apiKey: "AIzaSyDDEFb3BzaBdCTDYRmM5nCZRusXTy18PJU",
            authDomain: "scrapbook-10e8b.firebaseapp.com",
            projectId: "scrapbook-10e8b",
            storageBucket: "scrapbook-10e8b.firebasestorage.app",
            messagingSenderId: "855118378194",
            appId: "1:855118378194:web:298e480bd3a5afde8c290b",
            measurementId: "G-EG6FRJVWG7"
        };
        const imgbbAPIKey = "cc9a9150864e7f165dadd0a03edc641c";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- FUNGSI 1: UPLOAD FOTO ---
        const form = document.getElementById('memoryForm');

        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const btn = document.getElementById('btnSubmitFirebase');
                const originalText = btn.innerText;
                const fileInput = document.getElementById('photo');
                const file = fileInput.files[0];

                if (!file) { alert("Pilih fotonya dulu dong!"); return; }

                try {
                    btn.innerText = "Mengupload ke ImgBB... ‚è≥";
                    btn.disabled = true;

                    // 1. Upload ke ImgBB
                    const formData = new FormData();
                    formData.append("image", file);

                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPIKey}`, {
                        method: "POST",
                        body: formData
                    });

                    const dataBB = await response.json();

                    if (!dataBB.success) {
                        throw new Error("Gagal upload ImgBB: " + (dataBB.error ? dataBB.error.message : "Unknown error"));
                    }

                    let rawUrl = dataBB.data.display_url || dataBB.data.url;
                    let finalUrl = rawUrl.replace("i.ibb.co", "i.ibb.co.com"); 

                    // 2. Simpan ke Firebase
                    btn.innerText = "Menempel di Dinding... üìå";

                    await addDoc(collection(db, "gallery"), {
                        imageUrl: finalUrl,
                        title: document.getElementById('title').value,
                        // Kita simpan tanggal input user (format YYYY-MM-DD bisa disortir langsung)
                        date: document.getElementById('date').value, 
                        tag: document.getElementById('tag').value,
                        desc: document.getElementById('desc').value,
                        createdAt: new Date() // Tetap simpan ini untuk data cadangan
                    });

                    alert("Berhasil ditempel! üéâ");
                    form.reset();

                    if (window.switchTab) window.switchTab('gallery');
                    loadGalleryFromFirebase();

                } catch (error) {
                    console.error("Error:", error);
                    alert("Gagal: " + error.message);
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            });
        }

        // --- FUNGSI 2: LOAD GALERI (FIXED SORTING) ---
        window.loadGalleryFromFirebase = async () => {
            const galleryContainer = document.getElementById('gallery');
            const sortOrder = document.getElementById('sortOrder') ? document.getElementById('sortOrder').value : 'desc';

            galleryContainer.innerHTML = '';

            try {
                // PERBAIKAN: Ganti "createdAt" menjadi "date"
                // date adalah field tanggal yang kita ambil dari input kalender
                const q = query(collection(db, "gallery"), orderBy("date", sortOrder));
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    galleryContainer.innerHTML = '<div class="empty-state"><p>Dinding kenangan masih kosong...</p></div>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const id = doc.id; 
                    createVintageCard(data, id);
                });

                // Update Slider
                setTimeout(() => { if (window.initSlider) window.initSlider(); }, 1000);

            } catch (error) {
                console.error("Gagal load:", error);
            }
        };

        // --- FUNGSI 3: BUAT TAMPILAN VINTAGE ---
        function createVintageCard(data, docId) {
            const galleryContainer = document.getElementById('gallery');
            const item = document.createElement('div');
            item.className = 'memory-cluster';

            const rotPhoto = Math.random() * 6 - 3;
            const rotTitle = Math.random() * 10 - 5;
            const rotNote = Math.random() * 4 - 2;

            let finalLink = data.imageUrl || data.url || data.imageSrc;
            if (!finalLink) finalLink = "https://via.placeholder.com/400x300?text=No+Image";

            item.innerHTML = `
                <button class="btn-remove" onclick="window.hapusFoto('${docId}')" style="position:absolute; top:-10px; left:-10px; z-index:100; background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer;">x</button>
                
                <div class="paper-photo" style="transform: rotate(${rotPhoto}deg);">
                    <img src="${finalLink}" alt="${data.title}" loading="lazy">
                </div>
                
                <div class="paper-title" style="transform: rotate(${rotTitle}deg);">
                    üìå ${data.title}
                    <br><small style="font-size:0.7rem; opacity:0.8;">${formatDate(data.date)}</small>
                </div>
                
                <div class="paper-note" style="transform: rotate(${rotNote}deg);">
                    <p>${data.desc}</p>
                    <span class="clickable-tag" style="color:#d35400; font-weight:bold;">
                        #${data.tag}
                    </span>
                </div>
            `;

            galleryContainer.appendChild(item);
        }

        // --- FUNGSI HAPUS ---
        window.hapusFoto = async (idDoc) => {
            if (confirm("Yakin mau merobek kenangan ini? üò¢")) {
                try {
                    await deleteDoc(doc(db, "gallery", idDoc));
                    alert("Kenangan dihapus.");
                    loadGalleryFromFirebase();
                } catch (e) {
                    alert("Gagal hapus: " + e.message);
                }
            }
        };

        function formatDate(dateString) {
            // dateString dari input type="date" formatnya "YYYY-MM-DD"
            // Kita ubah jadi format Indonesia yang cantik
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            try { 
                const dateObj = new Date(dateString);
                return dateObj.toLocaleDateString('id-ID', options); 
            }
            catch (e) { return dateString; }
        }

        // Auto Load
        setTimeout(() => {
            const mainApp = document.getElementById('main-app');
            if (!mainApp.classList.contains('hidden')) {
                loadGalleryFromFirebase();
            }
        }, 1000);

        window.loadGalleryFromFirebase = loadGalleryFromFirebase;
    </script>
</body>

</html>