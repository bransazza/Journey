<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal Gibran & Farah</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Lobster+Two:ital,wght@0,400;0,700;1,400&family=Patrick+Hand&family=Quicksand:wght@400;600;700&display=swap"
        rel="stylesheet">

    <style>
        .hidden {
            display: none !important;
        }

        /* Pastikan Music Player Flexbox Rapi di HP (Force Fix) */
        @media (max-width: 600px) {
            .vinyl-player {
                position: fixed !important;
                left: 50% !important;
                bottom: 20px !important;
                transform: translateX(-50%) !important;
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                width: 90% !important;
                max-width: 350px !important;
                padding: 10px !important;
            }

            .vinyl-disk {
                position: relative !important;
                width: 50px !important;
                height: 50px !important;
                margin: 0 !important;
            }

            .player-info {
                padding-left: 0 !important;
                width: 100% !important;
            }

            .toggle-player-btn {
                position: absolute !important;
                right: -5px !important;
                top: -15px !important;
            }
        }
    </style>
</head>

<body>
    <div id="background-decor"></div>

    <div id="login-page" class="login-overlay">
        <div class="login-paper">
            <div class="tape-login"></div>
            <div class="stamp-secret">TOP SECRET</div>
            <h1>Journal</h1>
            <p>Masukkan kata sandi:</p>
            <div class="login-input-group">
                <input type="password" id="passcode" placeholder="Ketik di sini...">
            </div>
            <button id="btnLogin">Login</button>
            <p id="error-msg"></p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <nav class="navbar">
            <div class="nav-brand">Scrapbook</div>
            <div class="nav-menu">
                <button id="btn-view" class="nav-btn active-btn">Galeri</button>
                <button id="btn-plans" class="nav-btn">Plan</button>
                <button id="btn-add" class="nav-btn">Upload Galeri</button>
                <button id="btn-logout" class="nav-btn logout">Tutup</button>
            </div>
        </nav>

        <div class="container">
            <div class="timer-paper">
                <div class="pin"></div>
                <div id="timer">Menghitung hari...</div>
            </div>

            <section id="add-section" class="hidden">
                <div class="form-paper">
                    <div class="tape-corner"></div>
                    <h2>üìù Tulis Kenangan</h2>
                    <form id="memoryForm">
                        <div class="form-group">
                            <label>1. Pilih Foto:</label>
                            <input type="file" id="photo" accept="image/*" required>
                        </div>
                        <div class="form-group">
                            <label>2. Beri Judul:</label>
                            <input type="text" id="title" placeholder="Momen apa ini?" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tanggal:</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="form-group">
                                <label>Label:</label>
                                <select id="tag">
                                    <option value="Date">Date ‚ù§Ô∏è</option>
                                    <option value="Trip">Jalan-jalan ‚úàÔ∏è</option>
                                    <option value="Eat">Kulineran üçú</option>
                                    <option value="Random">Random ü§™</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>3. Ceritakan:</label>
                            <textarea id="desc" rows="4" placeholder="Tulis cerita di sini..." required></textarea>
                        </div>
                        <button type="submit" id="btnSubmitFirebase" class="btn-scrap">Simpan ke Awan ‚òÅÔ∏è</button>
                    </form>
                </div>
            </section>

            <section id="plans-section" class="hidden">
                <div class="plans-container">
                    <div class="paper-list travel-card">
                        <div class="stamp-decor">‚úàÔ∏èLet's Go</div>
                        <div class="tape-top-left"></div>
                        <h3>üåç Place to go</h3>
                        <div class="input-row-plan">
                            <input type="text" id="placeInput" placeholder="Mau kemana nih kita?">
                            <button id="btnAddPlace">GO!</button>
                        </div>
                        <ul id="placesList" class="scrap-list">
                            <li style="text-align:center; color:#888;">Memuat data...</li>
                        </ul>
                    </div>

                    <div class="paper-list bucket-card">
                        <div class="tape-bucket-center"></div>
                        <div class="doodle-star">‚òÖ</div>
                        <h3>üìù Things to do</h3>
                        <div class="input-row-plan">
                            <input type="text" id="todoInput" placeholder="Mau ngapain nih kita?">
                            <button id="btnAddTodo">ADD</button>
                        </div>
                        <ul id="todoList" class="scrap-list checklist">
                            <li style="text-align:center; color:#888;">Memuat data...</li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="gallery-section">
                <div id="highlight-wrapper" class="hidden">
                    <div class="vintage-slider">
                        <div class="slider-tape"></div>
                        <div id="slider-track" class="slider-track"></div>
                    </div>
                </div>

                <div class="controls-area">
                    <input type="text" id="searchInput" placeholder="Cari kenangan...">
                    <select id="sortOrder">
                        <option value="desc">Paling Baru</option>
                        <option value="asc">Paling Lama</option>
                    </select>
                </div>

                <div id="gallery" class="scrapbook-wall"></div>
            </section>
        </div>
    </div>

    <div class="vinyl-player" id="music-widget">
        <button id="btnToggleWidget" class="toggle-player-btn">‚úñ</button>
        <div class="vinyl-disk" id="vinyl">
            <div class="vinyl-grooves"></div>
            <div class="vinyl-label">üéµ</div>
        </div>
        <div class="player-info">
            <div class="now-playing-label">NOW PLAYING</div>
            <div class="song-title-wrapper">
                <span id="song-title">Select a song...</span>
            </div>
            <div class="player-controls">
                <button id="btnPrev">‚èÆ</button>
                <button id="btnPlay">‚ñ∂</button>
                <button id="btnNext">‚è≠</button>
            </div>
        </div>
        <audio id="audio"></audio>
    </div>

    <script type="module">
        console.log("üöÄ Script Dimulai...");

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore, collection, addDoc, getDocs,
            query, orderBy, deleteDoc, doc, updateDoc, onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDDEFb3BzaBdCTDYRmM5nCZRusXTy18PJU",
            authDomain: "scrapbook-10e8b.firebaseapp.com",
            projectId: "scrapbook-10e8b",
            storageBucket: "scrapbook-10e8b.firebasestorage.app",
            messagingSenderId: "855118378194",
            appId: "1:855118378194:web:298e480bd3a5afde8c290b",
            measurementId: "G-EG6FRJVWG7"
        };
        const imgbbAPIKey = "cc9a9150864e7f165dadd0a03edc641c";
        const PASSCODE = "GibranCintaFarah1506";
        const START_DATE = new Date("2025-06-15");

        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("‚úÖ Firebase Terhubung!");
        } catch (e) {
            console.error("‚ùå Firebase Error:", e);
            alert("Gagal konek ke database. Cek koneksi internet!");
        }

        // --- ELEMENTS ---
        const loginPage = document.getElementById('login-page');
        const mainApp = document.getElementById('main-app');
        const passcodeIn = document.getElementById('passcode');
        const errorMsg = document.getElementById('error-msg');

        // --- 1. SISTEM LOGIN (FIX BUG REFRESH & MACET) ---
        function showApp() {
            console.log("üîì Membuka Aplikasi...");

            // PAKSA HILANGKAN LOGIN PAGE
            loginPage.style.display = 'none';
            loginPage.classList.add('hidden');

            // TAMPILKAN MAIN APP
            mainApp.classList.remove('hidden');
            mainApp.style.display = 'block';

            updateTimer();
            initDoodles();

            // Load Data
            loadGalleryFromFirebase();
            subscribeToPlans();
            subscribeToTodos();
        }

        // Event Listener Login
        document.getElementById('btnLogin').addEventListener('click', () => {
            if (passcodeIn.value === PASSCODE) {
                sessionStorage.setItem('isLoggedIn', 'true');
                showApp();
            } else {
                errorMsg.innerText = "Kata sandi salah! üòú";
                passcodeIn.value = '';
            }
        });

        // Cek Login saat Refresh
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            showApp();
        }

        // Logout
        document.getElementById('btn-logout').addEventListener('click', () => {
            if (confirm("Yakin mau keluar?")) {
                sessionStorage.removeItem('isLoggedIn');
                location.reload();
            }
        });

        // --- 2. NAVIGASI TAB ---
        function switchTab(tabName) {
            const sections = ['gallery-section', 'add-section', 'plans-section'];
            const btns = {
                'gallery': 'btn-view',
                'add': 'btn-add',
                'plans': 'btn-plans'
            };

            // Sembunyikan semua section
            sections.forEach(sec => document.getElementById(sec).classList.add('hidden'));
            // Reset semua tombol
            Object.values(btns).forEach(btnId => document.getElementById(btnId).classList.remove('active-btn'));

            // Tampilkan yang dipilih
            if (tabName === 'gallery') {
                document.getElementById('gallery-section').classList.remove('hidden');
                document.getElementById('btn-view').classList.add('active-btn');
                loadGalleryFromFirebase();
            } else if (tabName === 'plans') {
                document.getElementById('plans-section').classList.remove('hidden');
                document.getElementById('btn-plans').classList.add('active-btn');
                document.getElementById('highlight-wrapper').classList.add('hidden'); // Matikan slider
            } else if (tabName === 'add') {
                document.getElementById('add-section').classList.remove('hidden');
                document.getElementById('btn-add').classList.add('active-btn');
                document.getElementById('highlight-wrapper').classList.add('hidden'); // Matikan slider
            }
        }

        // Pasang Event Listener Navigasi
        document.getElementById('btn-view').addEventListener('click', () => switchTab('gallery'));
        document.getElementById('btn-plans').addEventListener('click', () => switchTab('plans'));
        document.getElementById('btn-add').addEventListener('click', () => switchTab('add'));

        // --- 3. PLANS & TODOS (BACKEND) ---

        // A. PLACE TO GO
        function subscribeToPlans() {
            const q = query(collection(db, "plans"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('placesList');
                list.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    renderList(list, doc.id, data, 'plans');
                });
            });
        }

        // B. THINGS TO DO
        function subscribeToTodos() {
            const q = query(collection(db, "todos"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('todoList');
                list.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    renderList(list, doc.id, data, 'todos');
                });
            });
        }

        // Render List Item (Generic)
        function renderList(container, id, data, collectionName) {
            const rot = Math.random() * 4 - 2;
            const li = document.createElement('li');
            if (data.done) li.classList.add('completed');
            li.style.transform = `rotate(${rot}deg)`;

            // Kita pakai window function khusus untuk list item dinamis ini
            li.innerHTML = `
                <span onclick="window.toggleItem('${collectionName}', '${id}', ${data.done})">${collectionName === 'plans' ? 'üìç' : 'üìù'} ${data.text}</span> 
                <button class="btn-del-list" onclick="window.deleteItem('${collectionName}', '${id}')">‚úñ</button>
            `;
            container.appendChild(li);
        }

        // Event Listener Tombol Tambah
        document.getElementById('btnAddPlace').addEventListener('click', () => addItem('plans', 'placeInput'));
        document.getElementById('btnAddTodo').addEventListener('click', () => addItem('todos', 'todoInput'));

        async function addItem(collectionName, inputId) {
            const input = document.getElementById(inputId);
            if (input.value.trim() === '') return;
            try {
                await addDoc(collection(db, collectionName), {
                    text: input.value,
                    done: false,
                    createdAt: new Date().getTime()
                });
                input.value = '';
            } catch (e) { console.error("Error add:", e); }
        }

        // GLOBAL FUNCTIONS (Wajib nempel di window untuk onclick HTML dynamic)
        window.toggleItem = async (col, id, status) => {
            const docRef = doc(db, col, id);
            await updateDoc(docRef, { done: !status });
        };

        window.deleteItem = async (col, id) => {
            if (confirm("Hapus item ini?")) {
                await deleteDoc(doc(db, col, id));
            }
        };


        // --- 4. GALERI & UPLOAD ---
        const form = document.getElementById('memoryForm');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btnSubmitFirebase');
                const originalText = btn.innerText;
                const fileInput = document.getElementById('photo');
                const file = fileInput.files[0];

                if (!file) { alert("Pilih fotonya dulu dong!"); return; }

                try {
                    btn.innerText = "Mengupload ke ImgBB... ‚è≥";
                    btn.disabled = true;

                    const formData = new FormData();
                    formData.append("image", file);
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPIKey}`, {
                        method: "POST", body: formData
                    });
                    const dataBB = await response.json();
                    if (!dataBB.success) throw new Error("Gagal upload ImgBB");

                    let finalUrl = (dataBB.data.display_url || dataBB.data.url).replace("i.ibb.co", "i.ibb.co.com");

                    btn.innerText = "Menempel di Dinding... üìå";
                    await addDoc(collection(db, "gallery"), {
                        imageUrl: finalUrl,
                        title: document.getElementById('title').value,
                        date: document.getElementById('date').value,
                        tag: document.getElementById('tag').value,
                        desc: document.getElementById('desc').value,
                        createdAt: new Date()
                    });

                    alert("Berhasil ditempel! üéâ");
                    form.reset();
                    switchTab('gallery');
                } catch (error) {
                    console.error(error); alert("Gagal: " + error.message);
                } finally {
                    btn.innerText = originalText; btn.disabled = false;
                }
            });
        }

        async function loadGalleryFromFirebase() {
            const galleryContainer = document.getElementById('gallery');
            const sortOrder = document.getElementById('sortOrder').value;

            galleryContainer.innerHTML = '';

            try {
                const q = query(collection(db, "gallery"), orderBy("date", sortOrder));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    galleryContainer.innerHTML = '<div class="empty-state"><p>Dinding kenangan masih kosong...</p></div>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    createVintageCard(doc.data(), doc.id);
                });

                setTimeout(initSlider, 1000);
            } catch (error) { console.error("Gagal load:", error); }
        }

        // Event Listener Sort & Search
        document.getElementById('sortOrder').addEventListener('change', loadGalleryFromFirebase);
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const filter = e.target.value.toLowerCase();
            const cards = document.getElementsByClassName('memory-cluster');
            for (let i = 0; i < cards.length; i++) {
                const card = cards[i];
                card.style.display = card.innerText.toLowerCase().includes(filter) ? "" : "none";
            }
        });

        function createVintageCard(data, docId) {
            const galleryContainer = document.getElementById('gallery');
            const item = document.createElement('div');
            item.className = 'memory-cluster';

            const rotPhoto = Math.random() * 6 - 3;
            const rotTitle = Math.random() * 10 - 5;
            const rotNote = Math.random() * 4 - 2;
            let finalLink = data.imageUrl || "https://via.placeholder.com/400x300?text=No+Image";

            // Kita pakai window.hapusFoto karena ini elemen dinamis
            item.innerHTML = `
                <button class="btn-remove" onclick="window.hapusFoto('${docId}')" style="position:absolute; top:-10px; left:-10px; z-index:100; background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer;">x</button>
                <div class="paper-photo" style="transform: rotate(${rotPhoto}deg);">
                    <img src="${finalLink}" alt="${data.title}" loading="lazy">
                </div>
                <div class="paper-title" style="transform: rotate(${rotTitle}deg);">
                    üìå ${data.title} <br><small style="font-size:0.7rem; opacity:0.8;">${formatDate(data.date)}</small>
                </div>
                <div class="paper-note" style="transform: rotate(${rotNote}deg);">
                    <p>${data.desc}</p>
                    <span class="clickable-tag" style="color:#d35400; font-weight:bold;">#${data.tag}</span>
                </div>
            `;
            galleryContainer.appendChild(item);
        }

        window.hapusFoto = async (idDoc) => {
            if (confirm("Yakin mau merobek kenangan ini?")) {
                await deleteDoc(doc(db, "gallery", idDoc));
                loadGalleryFromFirebase();
            }
        };

        // --- 5. TIMER, SLIDER, MUSIC, DOODLES ---
        function updateTimer() {
            const now = new Date();
            let years = now.getFullYear() - START_DATE.getFullYear();
            let months = now.getMonth() - START_DATE.getMonth();
            let days = now.getDate() - START_DATE.getDate();
            if (days < 0) { months--; let p = new Date(now.getFullYear(), now.getMonth(), 0); days += p.getDate(); }
            if (months < 0) { years--; months += 12; }
            document.getElementById('timer').innerText = `Ciee udah pacaran selama: \n${years} Thn, ${months} Bln, ${days} Hari`;
        }

        function formatDate(dateString) {
            try { return new Date(dateString).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }); }
            catch (e) { return dateString; }
        }

        function initSlider() {
            const sliderTrack = document.getElementById('slider-track');
            const highlightWrapper = document.getElementById('highlight-wrapper');
            const photoCards = document.querySelectorAll('.memory-cluster');

            // Slider hanya muncul di galeri dan jika ada foto
            if (document.getElementById('gallery-section').classList.contains('hidden')) return;
            if (photoCards.length === 0) {
                if (highlightWrapper) highlightWrapper.classList.add('hidden');
                return;
            }
            if (highlightWrapper) highlightWrapper.classList.remove('hidden');
            if (sliderTrack) sliderTrack.innerHTML = '';

            const cardsArray = Array.from(photoCards);
            const shuffled = cardsArray.sort(() => 0.5 - Math.random()).slice(0, 5);

            shuffled.forEach((card, index) => {
                const imgEl = card.querySelector('.paper-photo img');
                const titleEl = card.querySelector('.paper-title');
                if (imgEl && titleEl) {
                    const imgSrc = imgEl.src;
                    let rawTitle = titleEl.childNodes[0].textContent.trim().replace('üìå', '').trim();
                    const slideDiv = document.createElement('div');
                    slideDiv.className = index === 0 ? 'slide active' : 'slide';
                    slideDiv.innerHTML = `<img src="${imgSrc}"><div class="slide-caption">${rawTitle}</div>`;
                    sliderTrack.appendChild(slideDiv);
                }
            });

            // Jalankan loop (Sederhana)
            let currentSlide = 0;
            const slides = document.querySelectorAll('.slide');
            if (slides.length > 1) {
                setInterval(() => {
                    slides[currentSlide].classList.remove('active');
                    currentSlide = (currentSlide + 1) % slides.length;
                    slides[currentSlide].classList.add('active');
                }, 5000);
            }
        }

        function initDoodles() {
            const container = document.getElementById('background-decor');
            if (!container) return;
            container.innerHTML = '';
            const svgs = [
                `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h19l-9 9"/><path d="M23 12L2 3"/></svg>`,
                `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`
            ];
            for (let i = 0; i < 15; i++) {
                const div = document.createElement('div');
                div.className = 'scrap-doodle';
                div.innerHTML = svgs[Math.floor(Math.random() * svgs.length)];
                div.style.left = `${Math.random() * 100}%`;
                div.style.top = `${Math.random() * 100}%`;
                div.style.width = `${Math.random() * 80 + 40}px`;
                div.style.height = div.style.width;
                div.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(div);
            }
        }

        // MUSIC PLAYER
        const playlist = [
            { title: "Ariana Grande - pov", src: "playlist/pov.mp3" },
            { title: "Harry Styles - Adore You", src: "playlist/adoreyou.mp3" },
            { title: "H.E.R. - Best Part", src: "playlist/bestpart.mp3" },
            { title: "Stephen Sanchez - Until I Found You", src: "playlist/foundyou.mp3" },
            { title: "Taylor Swift - So High School", src: "playlist/highscholl.mp3" },
            { title: "Lauv - I Like Me Better", src: "playlist/ilikemebetter.mp3" },
            { title: "Taylor Swift - You Are In Love", src: "playlist/inlove.mp3" },
            { title: "Taylor Swift - Paper Rings", src: "playlist/paperrings.mp3" },
            { title: "Taylor Swift - Lover", src: "playlist/lover.mp3" }
        ];
        let currentSongIndex = 0;
        const audio = document.getElementById('audio');
        const titleText = document.getElementById('song-title');
        const vinyl = document.getElementById('vinyl');

        function loadSong(index) {
            if (!audio) return;
            const song = playlist[index];
            titleText.innerText = song.title;
            audio.src = song.src;
        }

        function toggleMusic() {
            if (!audio.src) loadSong(0);
            if (audio.paused) {
                audio.play();
                document.getElementById('btnPlay').innerText = '‚è∏';
                if (vinyl) vinyl.style.animationPlayState = 'running';
            } else {
                audio.pause();
                document.getElementById('btnPlay').innerText = '‚ñ∂';
                if (vinyl) vinyl.style.animationPlayState = 'paused';
            }
        }

        function nextSong() {
            currentSongIndex = (currentSongIndex + 1) % playlist.length;
            loadSong(currentSongIndex);
            audio.play();
            document.getElementById('btnPlay').innerText = '‚è∏';
            if (vinyl) vinyl.style.animationPlayState = 'running';
        }

        function prevSong() {
            currentSongIndex = (currentSongIndex - 1 + playlist.length) % playlist.length;
            loadSong(currentSongIndex);
            audio.play();
            document.getElementById('btnPlay').innerText = '‚è∏';
            if (vinyl) vinyl.style.animationPlayState = 'running';
        }

        // Event Listener Musik
        document.getElementById('btnPlay').addEventListener('click', toggleMusic);
        document.getElementById('btnNext').addEventListener('click', nextSong);
        document.getElementById('btnPrev').addEventListener('click', prevSong);
        document.getElementById('btnToggleWidget').addEventListener('click', () => {
            document.getElementById('music-widget').classList.toggle('hide-widget');
        });

        if (audio) {
            audio.addEventListener('ended', nextSong);
            loadSong(currentSongIndex);
        }
    </script>
</body>

</html>